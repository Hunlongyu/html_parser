# HPS HTML 解析库 - 需求列表

> **项目定位**：高性能 HTML 解析库
> **核心原则**：只读解析，不编辑 DOM；尽可能快；不崩溃；完善报错
> **技术栈**：C++20

---

## 一、核心功能需求

### P0 - 必须实现（核心功能）

#### 1. HTML 实体解码完善
**需求描述**：支持所有 HTML5 实体，包括数字实体和命名实体

**子需求**：
- [ ] 支持基本实体（已完成：`&amp;`, `&lt;`, `&gt;`, `&quot;`, `&apos;`, `&nbsp;`）
- [ ] 支持数字十进制实体：`&#65;` → `A`
- [ ] 支持数字十六进制实体：`&#x41;` → `A`
- [ ] 支持命名实体（HTML5 标准 2520+ 个）：
  - 常用符号：`&copy;`, `&reg;`, `&trade;`, `&euro;`, `&pound;`, `&yen;`
  - 数学符号：`&sum;`, `&prod;`, `&int;`, `&infin;`
  - 希腊字母：`&alpha;`, `&beta;`, `&pi;`, `&Omega;`
  - 标点符号：`&ldquo;`, `&rdquo;`, `&lsquo;`, `&rsquo;`
  - 箭头符号：`&rarr;`, `&larr;`, `&uarr;`, `&darr;`
  - 其他：完整支持 HTML5 命名字符引用

**验收标准**：
- 通过所有实体解码测试用例
- 解码性能：1000 个实体 < 1ms
- 无内存泄漏

**实现位置**：`include/hps/utils/string_utils.hpp` 和 `src/utils/string_utils.cpp`

**优先级**：P0

---

#### 2. 错误处理机制完善
**需求描述**：确保任何情况下不崩溃，提供详细错误信息

**子需求**：
- [ ] 所有可能失败的操作都有错误处理
- [ ] 异常安全保证（基本/强异常安全）
- [ ] 完整的错误位置信息（行号、列号、偏移量）
- [ ] 错误恢复策略（Strict/Lenient/Ignore）
- [ ] 错误累积机制（收集所有错误而非只返回第一个）
- [ ] 友好的错误消息（中英文双语？）
- [ ] 内存耗尽保护（max_tokens, max_depth 等限制）
- [ ] 递归深度保护（防止栈溢出）

**验收标准**：
- 任何异常输入都不会导致程序崩溃
- 错误信息包含足够上下文用于调试
- 内存不足、深度超限等情况能优雅降级

**优先级**：P0

---

#### 3. 性能优化核心
**需求描述**：解决已识别的性能瓶颈，达到最快解析速度

**子需求**：

##### 3.1 内存管理优化
- [ ] 替换 `shared_ptr` 为 `unique_ptr` + 原始指针
  - Node 使用 `unique_ptr<Node>` 持有子节点
  - 使用 `Node*` 原始指针表示父子关系
  - 删除所有 `weak_ptr` 相关代码
- [ ] 移除 `Node::children()` 中的 vector 拷贝
  - 直接返回 `const std::vector<unique_ptr<Node>>&`
  - 添加迭代器接口避免拷贝
- [ ] 减少字符串拷贝
  - 优先使用 `std::string_view`
  - 延迟字符串创建
  - 合并中间字符串操作

##### 3.2 查询性能优化
- [ ] 实现 Document 索引机制
  - ID 索引：`std::unordered_map<std::string, const Element*>`
  - 类名索引：`std::unordered_map<std::string, std::vector<const Element*>>`
  - 标签索引：`std::unordered_map<std::string, std::vector<const Element*>>`
  - 懒构建和增量更新
  - Options 中添加索引开关
- [ ] 优化 `get_element_by_id()` 使用索引
- [ ] 优化 `get_elements_by_tag_name()` 使用索引
- [ ] 优化 `get_elements_by_class_name()` 使用索引

##### 3.3 HTML 实体解码优化
- [ ] 单次扫描解码算法
- [ ] 预编译实体映射表
- [ ] 数字实体快速解析（避免字符串转数字）

##### 3.4 Move 语义优化
- [ ] 所有函数参数支持 move 语义
- [ ] 添加右值引用重载
- [ ] 返回值优化（RVO/NRVO）

**验收标准**：
- ID 查询性能提升 > 100x（从 O(n) → O(1)）
- 类名查询性能提升 > 10x
- 标签查询性能提升 > 5x
- 内存占用减少 > 30%
- 实体解码性能提升 > 2x

**优先级**：P0

---

#### 4. RAII 资源管理
**需求描述**：所有资源通过 RAII 管理，避免资源泄漏

**子需求**：
- [ ] 所有类实现析构函数自动清理资源
- [ ] 文件句柄通过 RAII 管理（std::ifstream 封装）
- [ ] 动态内存通过智能指针或对象池管理
- [ ] 遵循 Rule of 5 / Rule of 0
- [ ] 异常安全保证

**验收标准**：
- Valgrind 检测无内存泄漏
- AddressSanitizer 检测无错误
- 所有测试用例通过资源检查

**优先级**：P0

---

### P1 - 重要优化

#### 5. 对象池管理小对象
**需求描述**：减少临时对象的内存分配开销

**子需求**：
- [ ] 实现 Token 对象池
- [ ] 实现 Attribute 对象池（可选）
- [ ] 在 Tokenizer 中集成对象池
- [ ] 性能对比测试（有/无对象池）

**验收标准**：
- 大量解析场景性能提升 > 10%
- 内存分配次数减少 > 50%

**优先级**：P1（需要性能基准测试验证收益）

---

#### 6. 单元测试补齐
**需求描述**：建立完整的单元测试体系，保证代码质量

**子需求**：
- [ ] 选择测试框架（Google Test / Catch2）
- [ ] 核心模块测试：
  - [ ] Tokenizer 测试（各种 HTML 片段）
  - [ ] TreeBuilder 测试（DOM 树构建）
  - [ ] CSS Parser 测试（各种选择器）
  - [ ] CSS Matcher 测试（查询准确性）
  - [ ] 实体解码测试（所有实体类型）
- [ ] 边界条件测试
- [ ] 异常情况测试
- [ ] 性能回归测试
- [ ] 代码覆盖率目标 > 80%

**验收标准**：
- 所有核心功能有测试覆盖
- 代码覆盖率 > 80%
- 持续集成自动运行测试

**优先级**：P1

---

#### 7. 性能基准测试
**需求描述**：建立性能基准，防止性能回归

**子需求**：
- [ ] 选择基准测试框架（Google Benchmark / 自定义）
- [ ] 基准测试场景：
  - [ ] 小型 HTML（< 10KB）
  - [ ] 中型 HTML（10KB - 100KB）
  - [ ] 大型 HTML（100KB - 1MB）
  - [ ] 超大型 HTML（> 1MB）
  - [ ] 深嵌套 HTML
  - [ ] 大量节点 HTML
- [ ] 性能指标：
  - [ ] 解析速度（MB/s 或 ops/s）
  - [ ] 内存占用（峰值、平均）
  - [ ] 查询性能（ID/类名/标签）
- [ ] 对比测试（优化前后、不同配置）
- [ ] 性能报告生成

**验收标准**：
- 有可重复的基准测试结果
- 优化后性能提升可量化
- 性能回归自动检测

**优先级**：P1

---

#### 8. 内存错误和泄漏监测
**需求描述**：建立内存安全检测机制

**子需求**：
- [ ] 集成 AddressSanitizer (ASan)
- [ ] 集成 LeakSanitizer (LSan)
- [ ] 集成 UndefinedBehaviorSanitizer (UBSan)
- [ ] 集成 ThreadSanitizer (TSan) - 如果有多线程
- [ ] CI/CD 中自动运行内存检测
- [ ] Valgrind 静态分析集成

**验收标准**：
- ASan/LSan/UBSan 检测无错误
- Valgrind 检测无泄漏
- 持续集成自动检测

**优先级**：P1

---

### P2 - 锦上添花

#### 9. Move 语义深度优化
**需求描述**：全面应用 move 语义优化性能

**子需求**：
- [ ] 审查所有函数参数，添加右值引用重载
- [ ] 优化链式调用（ElementQuery）
- [ ] 移动语义最佳实践文档

**优先级**：P2

---

#### 10. 代码静态分析
**需求描述**：引入静态分析工具提升代码质量

**子需求**：
- [ ] Clang-Tidy 配置和规则
- [ ] Cppcheck 静态分析
- [ ] SonarQube 代码质量分析（可选）
- [ ] CI/CD 集成静态分析

**优先级**：P2

---

#### 11. 文档完善
**需求描述**：完善 API 文档和使用指南

**子需求**：
- [ ] API 文档（Doxygen 自动生成）
- [ ] 性能调优指南
- [ ] 最佳实践文档
- [ ] 错误处理指南
- [ ] 迁移指南（如果有破坏性变更）

**优先级**：P2

---

## 二、明确不实现的需求

### ❌ 不实现

1. **XPath 支持**：暂时不支持，不在开发计划中
2. **DOM 编辑功能**：不提供 DOM 修改、删除、插入功能
3. **序列化功能**：不提供 DOM 树转 HTML 字符串功能
4. **可视化工具**：不提供 DOM 树可视化

---

## 三、技术约束

### 技术栈
- C++20
- CMake 3.28+
- MSVC 2022+（或兼容 C++20 的编译器）

### 性能底线
- 解析速度 > 10 MB/s（中型 HTML）
- ID 查询 < 1ms（10000 节点文档）
- 内存占用 < 解析文档大小的 3 倍

### 兼容性
- 支持 HTML5 标准
- 向后兼容 HTML4 部分特性
- 支持常见的错误 HTML（宽松模式）

---

## 四、验收标准

### 功能验收
- [ ] 所有 P0 功能实现并通过测试
- [ ] 所有 HTML5 实体正确解码
- [ ] 所有测试用例通过
- [ ] 代码覆盖率 > 80%

### 性能验收
- [ ] 性能基准测试达标
- [ ] 无性能回归
- [ ] 内存泄漏检测通过

### 质量验收
- [ ] 静态分析无严重问题
- [ ] 内存安全检测通过
- [ ] 代码符合规范（.clang-format）

---

## 五、优先级总结

### 立即实施（第一周）
1. HTML 实体解码完善
2. 错误处理机制完善
3. RAII 资源管理
4. 单元测试框架搭建

### 重点实施（第二-三周）
1. 内存管理优化（shared_ptr → unique_ptr）
2. 查询性能优化（索引机制）
3. 性能基准测试建立
4. 内存监测集成

### 优化完善（第四周）
1. 对象池实现和验证
2. Move 语义优化
3. 代码静态分析
4. 文档完善

---

## 六、开发检查清单

每次代码提交前检查：
- [ ] 单元测试全部通过
- [ ] 代码覆盖率未下降
- [ ] ASan/LSan/UBSan 检测通过
- [ ] Clang-Tidy 检查通过
- [ ] 性能基准测试未退化
- [ ] .clang-format 格式检查通过
- [ ] 代码审查通过

---

## 七、备注

### 设计决策记录
1. **不使用 shared_ptr**：为了性能和减少内存占用，采用 unique_ptr + 原始指针方案
2. **不实现 XPath**：暂时不支持，后续根据需求评估
3. **只读 DOM**：爬虫场景不需要编辑功能，简化设计
4. **对象池**：优先级中等，需要性能测试验证收益

### 风险提示
1. 替换智能指针可能引入生命周期问题，需要充分测试
2. 索引机制会增加内存占用，需要权衡
3. 大量实体解码可能影响性能，需要优化算法

---

**文档版本**：v1.0
**最后更新**：2025-01-14
**维护者**：HPS Team
